<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘é¡µç‰ˆèœ˜è››çº¸ç‰Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background-color: #006400;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            color: white;
            margin-bottom: 20px;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1000px;
        }

        .card-columns {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-column {
            width: 80px;
            height: 450px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            position: relative;
        }

        .card {
            width: 70px;
            height: 100px;
            border-radius: 8px;
            background-color: white;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            cursor: grab;
            position: absolute;
            transition: top 0.2s ease, left 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .card.back {
            background: linear-gradient(45deg, #e66465, #9198e5);
            color: transparent;
        }

        .card.dragging {
            opacity: 0.8;
            z-index: 100;
            cursor: grabbing;
        }

        .card.red {
            color: red;
        }

        .card.black {
            color: black;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            color: white;
            font-size: 18px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>èœ˜è››çº¸ç‰Œ</h1>
    <div class="game-container">
        <div class="card-columns" id="cardColumns"></div>
        <div class="controls">
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
        <div class="status" id="gameStatus">æ¸¸æˆå¼€å§‹ï¼è¯·å°†ç‰Œä»å¤§åˆ°å°æ’åˆ—ï¼ˆKâ†’Qâ†’Jâ†’...â†’Aï¼‰ï¼Œå¯æ‹–åŠ¨æ•´ç»„è¿ç»­ç‰Œ</div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const CONFIG = {
            columns: 10, // åˆ—æ•°
            ranks: ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'], // ç‰Œé¢
            suits: ['â™¥', 'â™¦', 'â™£', 'â™ '], // èŠ±è‰²
            cardHeight: 100, // ç‰Œé«˜åº¦
            cardGap: 25, // ç‰Œé—´è·
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            columns: [], // æ¯åˆ—çš„ç‰Œ
            draggingCard: null, // æ­£åœ¨æ‹–åŠ¨çš„ç‰Œ
            draggingColumn: -1, // æ‹–åŠ¨çš„ç‰Œæ‰€åœ¨åˆ—
            dragOffsetY: 0, // æ‹–åŠ¨åç§»é‡
            dragStartIndex: -1, // æ‹–åŠ¨çš„èµ·å§‹ç‰Œç´¢å¼•
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameState.columns = Array(CONFIG.columns).fill().map(() => []);
            generateCards();
            renderGame();
            bindEvents();
        }

        // ç”Ÿæˆå¹¶æ´—ç‰Œ
        function generateCards() {
            let allCards = [];
            // ç”Ÿæˆ4å¥—ç‰Œï¼ˆèœ˜è››çº¸ç‰Œæ ‡å‡†ï¼‰
            for (let s = 0; s < 4; s++) {
                for (let r = 0; r < CONFIG.ranks.length; r++) {
                    allCards.push({
                        rank: CONFIG.ranks[r],
                        rankIndex: r,
                        suit: CONFIG.suits[s % 4],
                        color: s % 2 === 0 ? 'red' : 'black',
                        faceUp: true, // å…¨éƒ¨æ­£é¢æœä¸Šï¼ˆç®€åŒ–ç‰ˆï¼‰
                    });
                }
            }

            // æ´—ç‰Œ
            allCards = shuffleArray(allCards);

            // åˆ†å‘åˆ°åˆ—
            let cardIndex = 0;
            for (let i = 0; i < CONFIG.columns; i++) {
                const cardsInColumn = Math.floor(allCards.length / CONFIG.columns) + (i < allCards.length % CONFIG.columns ? 1 : 0);
                gameState.columns[i] = allCards.slice(cardIndex, cardIndex + cardsInColumn);
                cardIndex += cardsInColumn;
            }
        }

        // æ•°ç»„æ´—ç‰Œï¼ˆFisher-Yatesç®—æ³•ï¼‰
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // æ¸²æŸ“æ¸¸æˆç•Œé¢
        function renderGame() {
            const columnsContainer = document.getElementById('cardColumns');
            columnsContainer.innerHTML = '';

            // æ¸²æŸ“æ¯ä¸€åˆ—
            gameState.columns.forEach((column, colIndex) => {
                const columnEl = document.createElement('div');
                columnEl.className = 'card-column';
                columnEl.dataset.column = colIndex;

                // æ¸²æŸ“åˆ—ä¸­çš„æ¯ä¸€å¼ ç‰Œ
                column.forEach((card, cardIndex) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = `card ${card.color} ${card.faceUp ? '' : 'back'}`;
                    cardEl.dataset.column = colIndex;
                    cardEl.dataset.index = cardIndex;
                    cardEl.style.top = `${cardIndex * CONFIG.cardGap}px`;
                    cardEl.textContent = card.faceUp ? `${card.rank}${card.suit}` : '';

                    columnEl.appendChild(cardEl);
                });

                columnsContainer.appendChild(columnEl);
            });
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restartBtn').addEventListener('click', initGame);

            // ç‰Œçš„æ‹–åŠ¨äº‹ä»¶
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        // é¼ æ ‡æŒ‰ä¸‹ï¼ˆå¼€å§‹æ‹–åŠ¨ï¼‰
        function handleMouseDown(e) {
            const cardEl = e.target.closest('.card');
            if (!cardEl) return;

            // è·å–æ‹–åŠ¨çš„ç‰Œä¿¡æ¯
            const colIndex = parseInt(cardEl.dataset.column);
            const cardIndex = parseInt(cardEl.dataset.index);
            const column = gameState.columns[colIndex];

            // è®°å½•æ‹–åŠ¨çŠ¶æ€
            gameState.draggingCard = cardEl;
            gameState.draggingColumn = colIndex;
            gameState.dragStartIndex = cardIndex;
            gameState.dragOffsetY = e.clientY - cardEl.getBoundingClientRect().top;

            // æ·»åŠ æ‹–åŠ¨æ ·å¼
            cardEl.classList.add('dragging');

            // è®©æ•´ç»„å¾…æ‹–åŠ¨çš„ç‰Œéƒ½è·Ÿéšï¼ˆå…³é”®ï¼šæ•´ä½“ç§»åŠ¨ï¼‰
            const columnEl = cardEl.parentElement;
            const cardsToDrag = columnEl.querySelectorAll(`.card[data-index]:not([data-index="${cardIndex}"])`);
            cardsToDrag.forEach(c => {
                if (parseInt(c.dataset.index) > cardIndex) {
                    c.classList.add('dragging');
                }
            });
        }

        // é¼ æ ‡ç§»åŠ¨ï¼ˆæ‹–åŠ¨ä¸­ï¼‰
        function handleMouseMove(e) {
            if (!gameState.draggingCard) return;

            // è®¡ç®—æ‹–åŠ¨ä½ç½®
            const cardRect = gameState.draggingCard.getBoundingClientRect();
            const newTop = e.clientY - gameState.dragOffsetY - document.querySelector('.game-container').getBoundingClientRect().top;

            // æ›´æ–°æ‹–åŠ¨ç‰Œçš„ä½ç½®
            gameState.draggingCard.style.top = `${newTop}px`;
            gameState.draggingCard.style.left = `${e.clientX - cardRect.width/2 - gameState.draggingCard.parentElement.getBoundingClientRect().left}px`;

            // åŒæ­¥æ›´æ–°æ•´ç»„ç‰Œçš„ä½ç½®ï¼ˆæ•´ä½“ç§»åŠ¨ï¼‰
            const colIndex = gameState.draggingColumn;
            const startIndex = gameState.dragStartIndex;
            const columnEl = gameState.draggingCard.parentElement;
            const cardsToDrag = columnEl.querySelectorAll(`.card[data-index]:not([data-index="${startIndex}"])`);

            cardsToDrag.forEach(c => {
                const idx = parseInt(c.dataset.index);
                if (idx > startIndex) {
                    const offset = idx - startIndex;
                    c.style.top = `${newTop + offset * CONFIG.cardGap}px`;
                    c.style.left = `${e.clientX - cardRect.width/2 - columnEl.getBoundingClientRect().left}px`;
                }
            });
        }

        // é¼ æ ‡æ¾å¼€ï¼ˆç»“æŸæ‹–åŠ¨ï¼‰
        function handleMouseUp(e) {
            if (!gameState.draggingCard) return;

            // æ‰¾åˆ°ç›®æ ‡åˆ—
            let targetColIndex = -1;
            const columns = document.querySelectorAll('.card-column');
            columns.forEach(col => {
                const rect = col.getBoundingClientRect();
                if (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom) {
                    targetColIndex = parseInt(col.dataset.column);
                }
            });

            // éªŒè¯ç§»åŠ¨è§„åˆ™å¹¶æ‰§è¡Œç§»åŠ¨
            if (targetColIndex !== -1 && targetColIndex !== gameState.draggingColumn) {
                moveCards(targetColIndex);
            }

            // é‡ç½®æ‹–åŠ¨çŠ¶æ€å’Œæ ·å¼
            document.querySelectorAll('.dragging').forEach(c => {
                c.classList.remove('dragging');
                c.style.top = '';
                c.style.left = '';
            });
            gameState.draggingCard = null;
            gameState.draggingColumn = -1;
            gameState.dragStartIndex = -1;
            gameState.dragOffsetY = 0;

            // é‡æ–°æ¸²æŸ“å¹¶æ£€æŸ¥æ¸¸æˆæ˜¯å¦èƒœåˆ©
            renderGame();
            checkWin();
        }

        // ç§»åŠ¨ç‰Œç»„ï¼ˆæ ¸å¿ƒï¼šæ•´ä½“ç§»åŠ¨+è§„åˆ™éªŒè¯ï¼‰
        function moveCards(targetColIndex) {
            const sourceColIndex = gameState.draggingColumn;
            const startIndex = gameState.dragStartIndex;
            const sourceColumn = gameState.columns[sourceColIndex];
            const targetColumn = gameState.columns[targetColIndex];

            // è¦ç§»åŠ¨çš„ç‰Œç»„
            const cardsToMove = sourceColumn.slice(startIndex);
            if (cardsToMove.length === 0) return;

            // éªŒè¯è§„åˆ™ï¼š
            // 1. ç›®æ ‡åˆ—æœ€åä¸€å¼ ç‰Œçš„ç‚¹æ•°å¿…é¡»æ¯”ç§»åŠ¨ç‰Œç»„ç¬¬ä¸€å¼ ç‰Œå¤§1ï¼ˆä»å¤§åˆ°å°ï¼šK(12) > Q(11) > ... > A(0)ï¼‰
            // 2. ç©ºåˆ—å¯ä»¥æ¥æ”¶ä»»æ„ç‰Œç»„
            const isValid = targetColumn.length === 0
                ? true
                : targetColumn[targetColumn.length - 1].rankIndex === cardsToMove[0].rankIndex + 1;

            if (isValid) {
                // æ‰§è¡Œç§»åŠ¨ï¼šä»æºåˆ—åˆ é™¤ï¼Œæ·»åŠ åˆ°ç›®æ ‡åˆ—
                gameState.columns[sourceColIndex] = sourceColumn.slice(0, startIndex);
                gameState.columns[targetColIndex] = [...targetColumn, ...cardsToMove];
                document.getElementById('gameStatus').textContent = 'ç§»åŠ¨æˆåŠŸï¼ç»§ç»­æ’åˆ—ç‰Œç»„';
            } else {
                document.getElementById('gameStatus').textContent = 'ç§»åŠ¨å¤±è´¥ï¼å¿…é¡»æŒ‰ä»å¤§åˆ°å°æ’åˆ—ï¼ˆå¦‚Kâ†’Qã€Qâ†’Jï¼‰';
            }
        }

        // æ£€æŸ¥æ˜¯å¦èƒœåˆ©ï¼ˆæ‰€æœ‰åˆ—éƒ½æŒ‰Kâ†’Aè¿ç»­æ’åˆ—ï¼‰
        function checkWin() {
            const allCompleted = gameState.columns.every(column => {
                if (column.length === 0) return true;
                // æ£€æŸ¥åˆ—æ˜¯å¦æ˜¯è¿ç»­çš„Kâ†’A
                for (let i = 0; i < column.length - 1; i++) {
                    if (column[i].rankIndex !== column[i+1].rankIndex + 1) {
                        return false;
                    }
                }
                return column[0].rankIndex === 12 && column[column.length - 1].rankIndex === 0;
            });

            if (allCompleted) {
                document.getElementById('gameStatus').textContent = 'æ­å–œï¼ä½ èµ¢äº†æ¸¸æˆğŸ‰';
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = initGame;
    </script>
</body>
</html>
